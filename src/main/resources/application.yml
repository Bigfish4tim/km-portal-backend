# ============================================
# KM 포털 백엔드 애플리케이션 설정
# Spring Boot 3.5.5 + JWT 인증 시스템 설정
#
# 버전 이력:
# - 18일차: 파일 시스템 설정 추가 (2025-11-12)
# - 36일차: API 성능 분석 도구 설정 강화 (2025-11-27)
# - 37일차: 쿼리 최적화 및 느린 쿼리 로깅 설정 (2025-11-28)
# ============================================

# ===== 서버 설정 =====
server:
  port: 8080
  servlet:
    context-path: /
    encoding:
      charset: UTF-8
      enabled: true
      force: true
  error:
    include-message: always
    include-binding-errors: always
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/xml,text/plain,application/javascript,text/css
    min-response-size: 1024

# ===== Spring 기본 설정 =====
spring:
  application:
    name: km-portal-backend

  # 데이터베이스 설정
  datasource:
    # H2 인메모리 데이터베이스 (개발용)
    url: jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE;MODE=MySQL
    driver-class-name: org.h2.Driver
    username: sa
    password:

    # 커넥션 풀 설정 (HikariCP)
    hikari:
      maximum-pool-size: 10
      minimum-idle: 2
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
      auto-commit: true
      pool-name: KMPortalHikariCP

  # JPA/Hibernate 설정
  jpa:
    database-platform: org.hibernate.dialect.H2Dialect
    hibernate:
      ddl-auto: create-drop
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.H2Dialect
        format_sql: true
        use_sql_comments: true
        jdbc:
          batch_size: 20
        order_inserts: true
        order_updates: true
        generate_statistics: true

        # ============================================
        # 37일차 추가: 느린 쿼리 로깅 설정
        # ============================================
        #
        # 이 설정은 지정된 시간(밀리초)보다 오래 걸리는 쿼리를 로그로 출력합니다.
        # 성능 문제 진단 및 쿼리 최적화에 매우 유용합니다.
        #
        # session.events.log.LOG_QUERIES_SLOWER_THAN_MS:
        # - 100: 100ms 이상 걸리는 쿼리 로그 출력
        # - 0 또는 음수: 느린 쿼리 로깅 비활성화
        #
        # 권장 값:
        # - 개발 환경: 100 (민감하게 탐지)
        # - 운영 환경: 1000 (1초 이상만 로그)
        #
        session:
          events:
            log:
              LOG_QUERIES_SLOWER_THAN_MS: 100

    defer-datasource-initialization: true

  # SQL 초기화 설정
  sql:
    init:
      mode: always
      data-locations: classpath:data-dev.sql
      encoding: UTF-8

  # H2 데이터베이스 콘솔 설정 (개발용)
  h2:
    console:
      enabled: true
      path: /h2-console
      settings:
        web-allow-others: true
        trace: false

  # Jackson JSON 설정
  jackson:
    serialization:
      write-dates-as-timestamps: false
      indent-output: true
    deserialization:
      fail-on-unknown-properties: false
    property-naming-strategy: LOWER_CAMEL_CASE
    time-zone: Asia/Seoul

  # 파일 업로드 설정
  servlet:
    multipart:
      enabled: true
      max-file-size: 50MB
      max-request-size: 100MB
      file-size-threshold: 2KB

  # 메시지 소스 설정
  messages:
    basename: messages
    encoding: UTF-8
    cache-duration: 3600

# ===== JWT 토큰 설정 =====
jwt:
  secret: myVerySecretKeyForKMPortal2025!@#$%^&*()_+1234567890
  expiration:
    access-token: 86400000
    refresh-token: 604800000
  header:
    authorization: Authorization
    prefix: "Bearer "
  issuer: km-portal-backend
  refresh:
    enabled: true
    auto-refresh-threshold: 300000

# ============================================
# 로깅 설정
# 37일차 업데이트: 쿼리 성능 분석 로깅 강화
# ============================================
logging:
  level:
    root: INFO
    com.kmportal.backend: DEBUG

    # Spring 관련 로깅
    org.springframework.web: DEBUG
    org.springframework.security: DEBUG

    # ============================================
    # 37일차: Hibernate 쿼리 성능 로깅 설정
    # ============================================

    # SQL 쿼리 출력
    org.hibernate.SQL: DEBUG

    # SQL 바인딩 파라미터 출력 (? 에 들어가는 실제 값)
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE

    # 37일차 추가: Hibernate 통계 로깅
    # 실행된 쿼리 수, 캐시 히트율 등 통계 정보 출력
    org.hibernate.stat: DEBUG

    # 37일차 추가: 느린 쿼리 로깅
    # LOG_QUERIES_SLOWER_THAN_MS 설정과 함께 사용
    org.hibernate.SQL_SLOW: WARN

    # 37일차 추가: 엔티티 로딩 분석 (N+1 문제 탐지용)
    # 주의: 매우 상세한 로그가 출력되므로 필요할 때만 활성화
    # org.hibernate.engine.internal.StatisticalLoggingSessionEventListener: DEBUG

    # H2 및 JDBC 로깅
    org.h2: DEBUG

    # JWT 라이브러리 로그
    io.jsonwebtoken: DEBUG

    # Actuator 로깅
    org.springframework.boot.actuate: INFO

    # 37일차 추가: 커넥션 풀 모니터링
    com.zaxxer.hikari: INFO
    com.zaxxer.hikari.HikariConfig: DEBUG

  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"

  file:
    name: logs/km-portal.log
    max-size: 100MB
    max-history: 30

# ===== 보안 설정 =====
security:
  password:
    min-length: 4
    max-length: 100
    require-uppercase: false
    require-lowercase: false
    require-numbers: false
    require-special: false
  account-lock:
    max-failed-attempts: 5
    lock-duration: 1800
  cors:
    allowed-origins:
      - http://localhost:3000
      - http://127.0.0.1:3000
    allowed-methods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
    allowed-headers:
      - "*"
    allow-credentials: true
    max-age: 3600

# ===== 파일 관리 설정 =====
file:
  storage:
    path: ${user.home}/km-portal-files
    allowed-extensions:
      - jpg
      - jpeg
      - png
      - gif
      - bmp
      - webp
      - pdf
      - doc
      - docx
      - xls
      - xlsx
      - ppt
      - pptx
      - txt
      - hwp
      - zip
      - rar
      - 7z
    max-size: 50MB
    max-total-size: 500MB
    auto-create-directory: true
    filename-strategy: uuid
    duplicate-strategy: rename

# ===== 애플리케이션 커스텀 설정 =====
app:
  name: KM 포털
  version: 1.0.0
  description: "지식관리 통합 업무 시스템"
  dev:
    enabled: true
    create-test-data: true
    enable-swagger: true
    show-sql-queries: true
  user:
    default-role: ROLE_USER
    auto-activate: true
    require-email-verification: false
  mail:
    enabled: false
    smtp:
      host: smtp.gmail.com
      port: 587
      username: ${MAIL_USERNAME:}
      password: ${MAIL_PASSWORD:}
      auth: true
      starttls: true
  cache:
    enabled: true
    default-ttl: 3600
    max-entries: 10000

# ============================================
# Actuator 설정 (모니터링)
# 37일차 업데이트: 쿼리 성능 메트릭 추가
# ============================================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,env,beans,loggers,mappings,caches
      base-path: /actuator
      cors:
        allowed-origins: http://localhost:3000
        allowed-methods: GET,POST
    jmx:
      exposure:
        exclude: "*"

  endpoint:
    health:
      show-details: when-authorized
      show-components: always
      probes:
        enabled: true
      group:
        liveness:
          include: livenessState
          show-details: always
        readiness:
          include: readinessState,db
          show-details: always
    info:
      enabled: true
    metrics:
      enabled: true
    loggers:
      enabled: true
    mappings:
      enabled: true
    caches:
      enabled: true

  health:
    db:
      enabled: true
    diskspace:
      enabled: true
      threshold: 100MB
    livenessstate:
      enabled: true
    readinessstate:
      enabled: true

  metrics:
    tags:
      application: ${spring.application.name}
      environment: development
    web:
      server:
        request:
          autotime:
            enabled: true
            percentiles: 0.5,0.95,0.99
    distribution:
      percentiles-histogram:
        http.server.requests: true
        # 37일차 추가: Hibernate 쿼리 히스토그램
        hibernate.query.executions: true
      slo:
        http.server.requests: 100ms,500ms,1s,5s
        # 37일차 추가: DB 쿼리 SLO
        jdbc.connections.acquire: 10ms,50ms,100ms

    # 37일차 추가: 활성화할 메트릭 필터
    enable:
      # JVM 메트릭
      jvm: true
      # 시스템 메트릭
      system: true
      # 프로세스 메트릭
      process: true
      # JDBC 메트릭
      jdbc: true
      # Hibernate 메트릭
      hibernate: true
      # HikariCP 메트릭
      hikaricp: true

  info:
    env:
      enabled: true
    java:
      enabled: true
    os:
      enabled: true
    build:
      enabled: true
    git:
      enabled: true
      mode: full

# ===== Info 엔드포인트 정보 =====
info:
  app:
    name: ${app.name}
    version: ${app.version}
    description: ${app.description}
    encoding: UTF-8
    java:
      version: ${java.version}
  build:
    date: "2025-11-28"
    day: 37
    phase: "4단계 - 완성 및 최적화"
  contact:
    email: admin@kmportal.com
    team: "KM Portal Development Team"
  features:
    authentication: JWT
    database: H2/MSSQL
    frontend: Vue 3 + Element Plus
    responsive: true
    # 37일차 추가
    query-optimization: enabled
    slow-query-logging: "100ms"

# ============================================
# 37일차 추가: 쿼리 성능 모니터링 가이드
# ============================================
#
# 1. 느린 쿼리 확인 방법:
#    - 애플리케이션 로그에서 "slow query" 검색
#    - LOG_QUERIES_SLOWER_THAN_MS 값 이상 걸린 쿼리 확인
#
# 2. Actuator로 확인 가능한 메트릭:
#
#    a) Hibernate 통계:
#       GET /actuator/metrics/hibernate.statements
#       GET /actuator/metrics/hibernate.query.executions
#       GET /actuator/metrics/hibernate.sessions.open
#
#    b) JDBC 커넥션 풀:
#       GET /actuator/metrics/hikaricp.connections.active
#       GET /actuator/metrics/hikaricp.connections.pending
#       GET /actuator/metrics/hikaricp.connections.acquire
#
#    c) HTTP 요청:
#       GET /actuator/metrics/http.server.requests
#
# 3. 쿼리 실행 계획 확인 (H2):
#    EXPLAIN ANALYZE SELECT * FROM boards WHERE is_deleted = false;
#
# 4. 인덱스 확인 (H2):
#    SELECT * FROM INFORMATION_SCHEMA.INDEXES WHERE TABLE_NAME = 'BOARDS';
#
# 5. 통계 초기화 (테스트용):
#    Hibernate Session Factory에서 statistics.clear() 호출
#
# ============================================